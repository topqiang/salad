<include file="Index:header"/>
<link rel="stylesheet" type="text/css" href="__WEBPUBLIC__/Home/css/fakeLoader.css">
	<header>
		<a href="javascript:history.go(-1);" class="arrow-l" id="BackIcon"></a>
		<h2><font id="_df10_title" style="">订单确认</font></h2>
		<font id="CartLine"><a href="{:U('Goods/gley')}"><span class="cart-ico"><em>{$count}</em></span></a></font>
	</header>
	<div class="con-wrap-bt">
		<div class="order-detail">
        	<div class="order-det-mod" style="display:none">
				<div class="det-dius-hd">
					<span class="d10-ico ico-13"></span><font id="_df10_sent_mothed" style="">送货方式</font>
				</div>
				<div class="det-dius-bd">
					<ul class="send-tit fl-clr">
						<li id="SendMole_2" onclick="CART.ChangeSendMole(2);" class="on"><font id="_df10_go_shop" style="">到店自提</font></li>
						<li id="SendMole_1" onclick="CART.ChangeSendMole(1);"><font id="_df10_sent_home" style="">送货上门</font></li>
					</ul>				
				</div>
			</div>
			<if condition="$ordinfo['delivertype'] eq 1">
				<div class="order-det-mod" id="SendShowLine">
					<div class="det-dius-hd">
						<a href="{:U('Address/index')}/oid/{$ordinfo.oid}">
						<span class="d10-ico ico-11"></span><font id="_df10_your_address" style="">收货地址</font>
						</a>
					</div>
					<ul class="det-dius-bd addr-list">
						<if condition="!empty($ordinfo['addname'])">
						<li id="SetAddressLine">
							<dl>
								<dt>
									<span class="mark-bl"><font id="_df10_sent" style="">【配送】</font></span>
									<font id="linkname">{$ordinfo.addname}</font>
								</dt>
								<dd id="linkphone">{$ordinfo.tel}</dd>
								<dd id="address">{$ordinfo.detailadd}</dd>
							</dl>
						</li>
						</if>
	                    <li id="NewAddressLine">
							<a href="{:U('Address/location')}/oid/{$ordinfo.oid}"><img src="__WEBPUBLIC__/Home/images/d10-add.png" width="50"></a>
						</li>
					</ul>
				</div>
			</if>

			<if condition="$ordinfo['delivertype'] eq 0">
	            <div class="order-det-mod" id="StoreShowLine">
					<div class="det-dius-hd">
						<a href="{:U('Address/index')}/oid/{$ordinfo.oid}">
						<span class="d10-ico ico-11"></span><font id="_df10_self_shop" style="">自提门店</font>
						</a>
					</div>
					<div class="ord-det-con addr-list">
						<dl>
							<dt><span class="mark-bl"><font id="_df10_self" style="">【自提】</font></span><font id="companytitle">{$ordinfo.addname}</font></dt>
							<dd id="companymobile">{$ordinfo.tel}</dd>
							<dd id="companyaddress">{$ordinfo.detailadd}</dd>
						</dl>
					</div>
				</div>
			</if>

			<if condition="!empty($goods)">
				<div class="order-det-mod">
					<div class="det-dius-hd">
						<span class="d10-ico ico-12"></span><font id="_df10_food_list" style="">餐品列表</font>
					</div>
					<div class="det-dius-bd ">
						<div class="tec-order" id="product">
						<table width="100%" cellpadding="0" cellspacing="0" border="0" class="tb-list">
							<tbody>
							<volist name="goods" id="good">
								<tr>
									<td class="td-1"><span>{$good.name}</span><i>X{$good.gnum}</i></td>
									<td class="td-2 mark-bl">￥{$good.gprice}</td>
								</tr>
							</volist>
							</tbody>
						</table>
						</div>
					</div>
				</div>
			</if>
				<div class="order-det-mod" id="SendTimeLine">
					<div class="det-dius-hd">
						<span class="d10-ico ico-16"></span>
						<font id="_df10_sent_time_one" style="">
							<if condition="$ordinfo['delivertype'] eq 1">配送时间<else/>自提时间</if>：
						</font>
					</div>
					<div class="det-dius-bd">
						<ul class="send-tit fl-clr">
							<li forid="AutoSendLine" class="checkon <if condition='empty($date)'>on</if>">
								<font id="_df10_sent_now">
									<if condition="$ordinfo['delivertype'] eq 1">立即配送<else/>立即自提</if>
								</font>
							</li>
							<li forid="SetDateLine" class="checkon <if condition='!empty($date)'>on</if>">
								<font id="_df10_sent_appiont">
									<if condition="$ordinfo['delivertype'] eq 1">预约配送<else/>预约自提</if>
								</font>
							</li>
						</ul>
						
						<div class="date-sele" id="SetDateLine" <if condition='empty($date)'>style="display:none"</if>>
							<select id="myFDDate" name="myFDDate">
								<option value="">选择时间</option>
								<option value="{$datee}" selected>{$datee}</option>
								<option value="{$tomaro}">{$tomaro}</option>
							</select>
							<select id="myFDTime" name="myFDTime">
								<option value="">选择时间</option>
								<option value="10:00-11:00" <if condition="!empty($time) && $time eq '10:00-11:00'">selected</if>>10:00-11:00</option>
								<option value="11:00-12:00" <if condition="!empty($time) && $time eq '11:00-12:00'">selected</if>>11:00-12:00</option>
								<option value="12:00-13:00" <if condition="!empty($time) && $time eq '12:00-13:00'">selected</if>>12:00-13:00</option>
								<option value="13:00-14:00" <if condition="!empty($time) && $time eq '13:00-14:00'">selected</if>>13:00-14:00</option>
								<option value="14:00-15:00" <if condition="!empty($time) && $time eq '14:00-15:00'">selected</if>>14:00-15:00</option>
								<option value="15:00-16:00" <if condition="!empty($time) && $time eq '15:00-16:00'">selected</if>>15:00-16:00</option>
								<option value="16:00-17:00" <if condition="!empty($time) && $time eq '16:00-17:00'">selected</if>>16:00-17:00</option>
								<option value="17:00-18:00" <if condition="!empty($time) && $time eq '17:00-18:00'">selected</if>>17:00-18:00</option>
								<option value="18:00-19:00" <if condition="!empty($time) && $time eq '18:00-19:00'">selected</if>>18:00-19:00</option>
							</select>
						</div>
						
						<div class="date-sele" id="AutoSendLine" <if condition='!empty($date)'>style="display:none"</if>>
							<span>
								<font id="_df10_sent_fast" style="">
									<if condition="$ordinfo['delivertype'] eq 1">我们将尽快配送<else/>请尽快到店自提</if>
								</font>
							</span>
						</div>
					</div>
				</div>
			<div class="order-det-mod">
				<div class="det-dius-hd">
					<span class="d10-ico ico-14"></span><font id="_df10_pay_mothed" style="">优惠方式</font>
				</div>
				<div class="date-sele" style="margin-top:10px">
					<select id="benefit" name="benefit">
						<option value="" selected>无</option>
						<volist name="coupon" id="vo">
							<if condition="$vo['type'] eq 1"><option value="{$vo.id}" type="{$vo.type}" man="{$vo.man}" jian="{$vo.jian}">满{$vo.man}减{$vo.jian}</option>
							<elseif condition="$vo['type'] eq 2"/><option value="{$vo.id}" type="{$vo.type}" zhe="{$vo.zhe}">{$vo.zhe}折</option>
							<elseif condition="$vo['type'] eq 3"/><option value="{$vo.id}" type="{$vo.type}" miane="{$vo.miane}">优惠{$vo.miane}</option>
							</if>
						</volist>
					</select>
				</div>
			</div>
			<div class="order-det-mod">
				<div class="det-dius-hd">
					<span class="d10-ico ico-14"></span><font id="_df10_pay_mothed" style="">付款方式</font>
				</div>
				<div class="det-dius-bd">
					<ul class="det-pay" id="payinfo">
						<li class="on" yes="1"><em><img src="__WEBPUBLIC__/Home/images/pay-1.png"></em>(推荐)微信支付</li>
						<!-- <li <if condition="$ordinfo['paytype'] eq 0">class="on"</if> yes="0"><em><img src="__WEBPUBLIC__/Home/images/payit.png"></em>货到付款</li> -->
						<!-- <li <if condition="$ordinfo['paytype'] eq 2">class="on"</if> yes="2"><em><img src="__WEBPUBLIC__/Home/images/balance.png"></em>余额支付</li> -->
					</ul>
				</div>
			</div>
			<div class="order-det-mod" style="display:none">
				<div class="det-dius-hd">
					<span class="d10-ico ico-15"></span>发票信息
				</div>
				<div class="det-dius-bd">
					<div class="self-comp">
						<p>
							<span id="InvoiceTypeLine_0" class="on" onclick="CART.SetInvoiceType(0);">不需要发票</span>
                            <span id="InvoiceTypeLine_1" onclick="CART.SetInvoiceType(1);">个人</span>
                            <span id="InvoiceTypeLine_2" onclick="CART.SetInvoiceType(2);">公司</span>
						</p>
						<input style="display:none" type="text" id="myInvoiceTitle" name="myInvoiceTitle" placeholder="请输入发票的抬头" onchange="CART.SaveInvoiceInfo();" onblur="CART.SaveInvoiceInfo();" class="inpt"> 
					</div>
				</div>
			</div>
			<div class="order-det-mod">
				<div class="det-dius-bd tb-outer">
					<table width="100%" cellpadding="0" cellspacing="0" border="0" class="tb-que" id="bonus">
						<tbody>
							<tr>
								<td class="tb-l"><font id="_df10_totall_pay" style="">总金额：</font></td>
								<td class="tb-r">￥<span id="totalprice">{$ordinfo.price}</span></td>
							</tr>
							<tr>
								<td class="tb-l"><font id="_df10_trans_pay" style="">运 费：</font></td>
								<td class="tb-r">￥<span id="freightprice">{$ordinfo.luggage}</span></td>
							</tr>
							<tr>
								<td class="tb-l">总优惠金额：</td>
								<td class="tb-r">-￥<span id="benepri">{$ordinfo.benefit}</span></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="order-det-mod">
				<div class="det-dius-bd msg">
					<input type="text" placeholder="请输入您的留言" class="inpt" name="remark" id="remark" rows="5" value="{$ordinfo.remark}">
				</div>
			</div>
		</div>
	</div>
	<div class="choose-menu">
		<div class="ord-que fl-clr">
			<span><font id="_df10_have_pay" style="">需要支付：</font></span><i>￥<font id="accountprice">{$ordinfo.paymoney}</font></i>
			<div class="pay-btn fl-right"><img src="__WEBPUBLIC__/Home/images/d10-ico-2.png" width="34"><font id="_df10_enter_pay">确认</font></div>
		</div>
	</div>
<script src="__WEBPUBLIC__/Home/js/config.js"></script>
<script src="__WEBPUBLIC__/Home/js/jweixin-1.0.0.js"></script>
<script src="__WEBPUBLIC__/Home/js/jquery-1.7.2.min.js" type="text/javascript"></script>
<script src="__WEBPUBLIC__/Home/js/zepto.js" type="text/javascript"></script>
<script src="__WEBPUBLIC__/Home/js/touch.js" type="text/javascript"></script>
<!-- <script src="__WEBPUBLIC__/Home/js/wewing.token.js"></script>
<script src="__WEBPUBLIC__/Home/js/wewing.init.js"></script> -->
<!-- <script src="__WEBPUBLIC__/Home/js/cart.js"></script>
<script src="__WEBPUBLIC__/Home/js/orders.js"></script> -->
<script language="javascript">
$(function(){
	//优惠方式切换事件响应
	$("#benefit").on('change',function(){
		var id = $(this).val();
		var self = $("#benefit option[value="+id+"]");
		var luggage = $("#freightprice").text()-0;
		var totalprice = $("#totalprice").text()-0;
		var accountprice = luggage + totalprice;
		switch(self.attr("type")){
			case "1":
			if (self.attr( "man" ) <= totalprice) {
				accountprice = accountprice - self.attr('jian');
			};
			break;
			case "2":
				accountprice = totalprice*self.attr("zhe")/10 + luggage;
			break;
			case "3":
				var price = accountprice - self.attr('miane');
				accountprice = (price>0) ? price : 0;
			break;
			default:
				$("#accountprice").text( accountprice );
			break;
		}
		$("#accountprice").text( accountprice );
		$("#benepri").text(((luggage+totalprice)*100-accountprice*100)/100);
	});
	$(".checkon").on('tap',function(){
		var self = $(this);
		var id = self.attr("forid");
		if (self.index() == 0) {
			var h = new Date().getHours();
			if ( h < 9 || h > 19) {
				alert("立即配送必须在9:00--19:00之间！");
				return;
			};
		};
		self.addClass("on").siblings().removeClass("on");
		$("#"+id).show().siblings("div").hide();
	});
	$("#payinfo li").on("tap",function(){
		var self = $(this);
		self.addClass("on").siblings().removeClass("on");
	});
	$(".pay-btn").on("tap",function(){
		var delidate = $("#SetDateLine:visible");
		var paytype = $("#payinfo li.on");
		var remark = $("#remark");
		var SetAddressLine = $(".addr-list li");
		var data = { "id" : "{$ordinfo.oid}" };
		if (!SetAddressLine || SetAddressLine.length < 2) {
			alert("请添加有效地址！");
			return;
		};
		if ( delidate.length != 0 ) {
			var myFDDate = $("#myFDDate").val();
			var myFDTime = $("#myFDTime").val();
			if (myFDDate && myFDTime) {
				delidate = myFDDate+ "=" + myFDTime;
				data.delidate = delidate;
			}else{
				alert("请填写完整时间！");
				return;
			}
		}else{
			data.delidate = "尽快";
		}
		if ( paytype ) {
			paytype = paytype.attr("yes");
			if ( paytype ) {
				data.paytype = paytype;
				if (paytype == 0) {
					data.type = 2;//货到付款直接到待收货
				}else if (paytype == 1) {
					//data.type = 1;//微信支付调用微信支付api
				}
			};
		};
		if ( remark ) {
			remark = remark.val();
			data.remark = remark;
		};
		var benefit = $("#benepri").text();
		var paymoney = $("#accountprice").text();
		var couid = $("#benefit").val();
		if ( benefit ){
			data.benefit = benefit;
		};
		if ( paymoney ){
			data.paymoney = paymoney;
		};
		if ( data.id != "" ) {
			$.ajax({
				"url" : "{:U('Order/updorder')}",
				"type" : "post",
				"data" : { "order" : data , "couid" : couid},
				"dataType" : "json",
				"success" : function( res ){
					if (res == "error") {
						alert("提交失败！");
					}else if(res == "gopay"){
						window.location.href="{:U('Order/gopay')}/oid/{$ordinfo.oid}";
					}else{
						window.location.href="{:U('Order/orderlist')}";
					}
				},
				"error"  : function ( res ) {
					console.log(res);
				}
			})
		};
	});
})
</script>

</body></html>